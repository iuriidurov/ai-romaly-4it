# AI-Romaly: Музыкальный Агрегатор

Этот проект представляет собой полнофункциональный веб-сайт, разработанный как агрегатор AI-сгенерированной музыки. Платформа позволяет авторам загружать свои треки, а пользователям — слушать и скачивать их. Проект включает в себя систему аутентификации, разделение ролей (администратор и автор), персональные кабинеты для авторов, панель администрирования и систему модерации контента.

## Технологический стек

*   **Бэкенд:** Node.js, Express.js
*   **База данных:** MongoDB с использованием Mongoose
*   **Фронтенд:** HTML5, CSS3, ванильный JavaScript (ES6+)
*   **Аутентификация:** JSON Web Tokens (JWT)
*   **Загрузка файлов:** Multer

---

## Функциональность

### Для всех пользователей:
*   Просмотр и прослушивание только одобренных модераторами треков.
*   Регистрация и аутентификация.
*   Восстановление пароля.

### Для авторов (после аутентификации):
*   Личный кабинет со списком загруженных треков и их статусом модерации.
*   Загрузка новых треков, которые отправляются на модерацию.
*   Удаление своих треков.

### Для администраторов:
*   Доступ к панели управления.
*   Управление сборниками (создание, редактирование, удаление).
*   **Модерация треков (одобрение/отклонение)**.
*   Управление пользователями (просмотр, удаление).

---

## Структура проекта и описание файлов

### Корневая директория (`/`)

*   **`server.js`**: Главный файл приложения.
*   **`index.html`**: Главная страница сайта.
*   **`author.html`**: Личный кабинет автора.
*   **`admin-collections.html`**: Страница управления сборниками.
*   **`admin-moderation.html`**: Страница для модерации треков (доступна администраторам).
*   **`package.json`**: Зависимости и скрипты проекта.

### Директория `js/`

*   **`main.js`**: Клиентский JS для `index.html`.
*   **`author.js`**: Клиентский JS для `author.html`. Отображает треки автора, их статус, управляет загрузкой.
*   **`admin-collections.js`**: Клиентский JS для управления сборниками.

---

## План разработки: Функциональность Сборников

Этот план описывает пошаговую реализацию новой системы курируемых администратором сборников треков.

### Этап 1: Бэкенд — Модель данных и API

1.  **Восстановить модель `Collection`:**
    *   **Файл:** `models/Collection.js`
    *   **Задача:** Создать схему Mongoose для сборников с полями: `name`, `description`, `coverImagePath`, `tracks` (массив ID треков), `createdBy` (ID администратора).

2.  **Создать контроллер `collectionController`:**
    *   **Файл:** `controllers/collectionController.js`
    *   **Задача:** Реализовать всю серверную логику:
        *   `createCollection`: Создание нового сборника (только для админа).
        *   `getAllCollections`: Получение списка всех сборников для боковой панели.
        *   `getCollectionById`: Получение детальной информации о сборнике и списка его треков.
        *   `addTrackToCollection`: Добавление трека в один или несколько сборников.
        *   `deleteCollection`: Удаление сборника (только для админа).

3.  **Определить маршруты API для сборников:**
    *   **Файл:** `routes/collections.js`
    *   **Задача:** Создать эндпоинты для управления сборниками:
        *   `POST /api/collections` (создать)
        *   `GET /api/collections` (получить все)
        *   `GET /api/collections/:id` (получить один)
        *   `PUT /api/collections/add-track` (добавить трек в сборники)
        *   `DELETE /api/collections/:id` (удалить)
    *   Подключить новые маршруты в `server.js`.

### Этап 2: Фронтенд — Интерфейс Администратора

1.  **Реализовать форму создания сборника:**
    *   **Файлы:** `index.html`, `js/main.js`
    *   **Задача:** На главной странице для администратора отобразить кнопку "Создать сборник". По клику открывать модальное окно с формой (название, обложка, описание) и отправлять данные на сервер.

2.  **Реализовать механизм добавления треков:**
    *   **Файлы:** `js/main.js`, `js/author.js` и другие, где есть списки треков.
    *   **Задача:** Если пользователь — администратор, рядом с каждым треком на сайте отображать иконку "+". По клику на нее открывать модальное окно со списком существующих сборников для выбора.

### Этап 3: Фронтенд — Публичный Интерфейс

1.  **Создать страницу сборника:**
    *   **Файлы:** `collection.html`, `js/collection.js`
    *   **Задача:** Создать новую страницу, которая будет получать ID сборника из URL, загружать его данные и отображать обложку, описание и список треков с пагинацией.

2.  **Сделать боковую панель динамической:**
    *   **Файлы:** `index.html`, `author.html`, `js/main.js` и др.
    *   **Задача:** Заменить статичный список сборников в левой колонке на динамический. JavaScript будет загружать список с сервера и формировать меню со ссылками на страницы сборников.
*   **`admin-moderation.js`**: Клиентский JS для страницы модерации. Загружает треки, ожидающие проверки, и отправляет запросы на их одобрение или отклонение.

### Директория `models/`

*   **`User.js`**: Модель пользователя (`name`, `emailOrPhone`, `password`, `role`).
*   **`Track.js`**: Модель трека (`title`, `author`, `filePath`, `collectionId`, `status`). Поле `status` может принимать значения `pending`, `approved`, `rejected`.
*   **`Collection.js`**: Модель сборника (`name`).

### Директория `controllers/`

*   **`userController.js`**: Логика для пользователей.
*   **`trackController.js`**: Логика для треков, включая функции для модерации (получение списка на модерацию, одобрение, отклонение).
*   **`collectionController.js`**: Логика для CRUD-операций со сборниками.

### Директория `routes/`

*   **`users.js`**: API-маршруты для пользователей.
*   **`tracks.js`**: API-маршруты для треков, включая защищенные маршруты для модерации.
*   **`collections.js`**: API-маршруты для сборников.

### Директория `middleware/`

*   **`auth.js`**: Middleware для проверки JWT-токена.
*   **`admin.js`**: Middleware для проверки роли администратора.

---

## API модерации

Все маршруты модерации защищены и доступны только администраторам.

*   `GET /api/tracks/pending`
    *   Получает список всех треков со статусом `pending`.

*   `PUT /api/tracks/:id/approve`
    *   Изменяет статус трека на `approved`.
    *   `:id` - идентификатор трека.

*   `PUT /api/tracks/:id/reject`
    *   Изменяет статус трека на `rejected`.
    *   `:id` - идентификатор трека.

---

## Аудит и план оптимизации (от 03.07.2025)

Проведен полный аудит проекта, в результате которого был составлен план по улучшению кодовой базы, повышению ее надежности и чистоты.

### 1. Удаление лишних файлов и кода

*   **Удалить `cleanup.js`**: Этот файл является скриптом для разовой очистки и не используется в основном приложении. Его удаление сделает структуру проекта чище.
*   **Удалить дублирующийся код**: В файлах `js/main.js` и `js/author.js` повторяется функция `parseJwt`. Ее необходимо вынести в отдельный утилитный файл `js/utils.js`, чтобы следовать принципу DRY (Don't Repeat Yourself).

### 2. Рефакторинг и улучшение кода

*   **Рефакторинг `userController.js`**:
    *   **Вынести создание JWT**: Логика генерации токена дублируется в функциях `register` и `login`. Ее следует вынести в отдельную вспомогательную функцию для переиспользования.
    *   **Унифицировать логирование ошибок**: Привести все вызовы `console.error` к единому формату для более удобной и предсказуемой отладки.
*   **Рефакторинг клиентского JavaScript**:
    *   **Избавиться от глобальных переменных**: Пересмотреть использование глобальной переменной `currentUser` и заменить ее на более надежный подход с чтением токена по мере необходимости (как это уже сделано в модальном окне загрузки).
    *   **Улучшить обработку `fetch`**: Добавить в клиентский код более надежную проверку ответов от сервера (например, `if (!response.ok)`), чтобы корректно обрабатывать HTTP-ошибки.

### 3. Повышение безопасности

*   **Вынести `jwtSecret` в переменные окружения**: В файле `config/default.json` хранится секретный ключ для JWT. Для повышения безопасности его следует перенести из файла конфигурации в переменные окружения (использование `.env` файла).
